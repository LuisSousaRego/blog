<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet">

        <title>Audit trail in PostgreSQL</title>

        <link rel="stylesheet" href="/css/stylesheet.css">
    </head>
    <body>
        <section id="page-title">
            <h1><a href="/">Overcoming poor programming</a></h1>
        </section>



<section class="blog-post">
    <h1>Audit trail in PostgreSQL</h1>
    <div class="blog-post-subheader">
        July 13, 2021
    </div>
    <div class="blog-post-content">
        <p>6 months or so ago I was building an app that required implementing an audit trail in a PostgreSQL database. At the time I had almost no experience with SQL, so I struggled a bit to find what ended up being quite a simple solution. During this struggle I could not find online almost any resources about what I thought was a common problem, so I&rsquo;ll share what I got.</p>
<p>I was building a web app that would allow a small group of internal users to do CRUD like operations safely on a PostgreSQL database. These users had to be able to search, create, change and delete results in some of the database tables just by opening a web page, authenticating, looking through lists and clicking a few buttons.</p>
<p>One fundamental requirement was an audit trail. The database should have a new &ldquo;audit&rdquo; table where all the changes made to the other tables using this web app had to be registered.
More specifically, the state of each row before and after the change, as well as the user id of whoever was using the app.</p>
<p>At the time I struggled with two things:</p>
<p>First, I only had access to the user id at the application level, and only had access to the state of the rows at the database level. It was not easy in the backend to know how each row being changed was before the change happened, and I couldn&rsquo;t figure out how the database could know what was the right user id for each individual query.
Second, the database was used by other services and I only wanted the audit to happen when the data was changed by this app.</p>
<p>Trying to solve this I tried a lot of different ideas, some of them more sensible than others, until after long googling sessions finally finding the key to solve both problems:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-SQL" data-lang="SQL"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">LOCAL</span><span style="color:#bbb"> </span>audit.userId<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">TO</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;123&#39;</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>PostgreSQL allows to set custom variables at any time by querying the database. This means the backend can tell the database which user is doing what by setting a custom var with the user id. Furthermore the var can be set locally inside a transaction so it only changes value for operations happening inside that transaction. Because other services won&rsquo;t be using this var, their changes won&rsquo;t be audited, and because I can wrap all queries from this app inside a transaction, concurrent requests to the database will still register the right user id.</p>
<p>So here is a possible minimal implementation for the problem:</p>
<p>Start by creating the audit table in the database</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-SQL" data-lang="SQL"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>audit<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>id<span style="color:#bbb"> </span><span style="color:#0086b3">serial</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">KEY</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>userId<span style="color:#bbb"> </span><span style="color:#0086b3">int</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>stateBefore<span style="color:#bbb"> </span>json,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>stateAfter<span style="color:#bbb"> </span>json,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">FOREIGN</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">KEY</span><span style="color:#bbb"> </span>(userId)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">REFERENCES</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span>users_table<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>(id)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>);<span style="color:#bbb">
</span></span></span></code></pre></div><p>The user id field references the user record in the proper table and the states of the rows are converted and saved as json.</p>
<p>Then create the function that will be called by the trigger:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-SQL" data-lang="SQL"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">OR</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">REPLACE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">FUNCTION</span><span style="color:#bbb"> </span>audit_trigger()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">RETURNS</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">TRIGGER</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">AS</span><span style="color:#bbb"> </span><span style="color:#a61717;background-color:#e3d2d2">$</span>audit_trigger$<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">DECLARE</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>uid<span style="color:#bbb"> </span><span style="color:#0086b3">integer</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">BEGIN</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>uid<span style="color:#bbb"> </span>:<span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>current_setting(<span style="color:#d14">&#39;audit.userId&#39;</span>,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span>)::<span style="color:#0086b3">integer</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">IF</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">EXISTS</span><span style="color:#bbb"> </span>(<span style="color:#000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span>id<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">FROM</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span>users_table<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">WHERE</span><span style="color:#bbb"> </span>id<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>uid)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">THEN</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">IF</span><span style="color:#bbb"> </span>(TG_OP<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;INSERT&#39;</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">THEN</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>audit<span style="color:#bbb"> </span>(userId,<span style="color:#bbb"> </span>stateBefore,<span style="color:#bbb"> </span>stateAfter)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(uid,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb"> </span>row_to_json(<span style="color:#000;font-weight:bold">NEW</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">ELSIF</span><span style="color:#bbb"> </span>(TG_OP<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;UPDATE&#39;</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">THEN</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>audit<span style="color:#bbb"> </span>(userId,<span style="color:#bbb"> </span>stateBefore,<span style="color:#bbb"> </span>stateAfter)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(uid,<span style="color:#bbb"> </span>row_to_json(<span style="color:#000;font-weight:bold">OLD</span>),<span style="color:#bbb"> </span>row_to_json(<span style="color:#000;font-weight:bold">NEW</span>));<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">ELSIF</span><span style="color:#bbb"> </span>(TG_OP<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;DELETE&#39;</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">THEN</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">INTO</span><span style="color:#bbb"> </span>audit<span style="color:#bbb"> </span>(userId,<span style="color:#bbb"> </span>stateBefore,<span style="color:#bbb"> </span>stateAfter)<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#000;font-weight:bold">VALUES</span><span style="color:#bbb"> </span>(uid,<span style="color:#bbb"> </span>row_to_json(<span style="color:#000;font-weight:bold">OLD</span>),<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#000;font-weight:bold">RETURN</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">OLD</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">END</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">IF</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">END</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">IF</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">RETURN</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NEW</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">END</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#a61717;background-color:#e3d2d2">$</span>audit_trigger$<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">LANGUAGE</span><span style="color:#bbb"> </span>plpgsql;<span style="color:#bbb">
</span></span></span></code></pre></div><p>This function reads the user id from the custom var and the state of the affected rows before and after the change, then it uses this information to create the proper records in the &ldquo;audit&rdquo; table. If the userId does not correspond to a valid user, the function doesn&rsquo;t do anything.</p>
<p>Now apply the trigger to every table that needs auditing.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-SQL" data-lang="SQL"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">TRIGGER</span><span style="color:#bbb"> </span>internal_user_audit<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">BEFORE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">UPDATE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">OR</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">OR</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">DELETE</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">ON</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">table_name</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">FOR</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">EACH</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">ROW</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">EXECUTE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">PROCEDURE</span><span style="color:#bbb"> </span>dashboard_audit();<span style="color:#bbb">
</span></span></span></code></pre></div><p>Finally in the backend wrap every query inside a transaction and set the right userId in the beginning.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-SQL" data-lang="SQL"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">BEGIN</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">SET</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">LOCAL</span><span style="color:#bbb"> </span>audit.userId<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">TO</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span>user_id<span style="color:#000;font-weight:bold">&gt;</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">-- query here
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">COMMIT</span>;<span style="color:#bbb">
</span></span></span></code></pre></div><p>And that&rsquo;s it. Quite simple. An audit trail for PostgreSQL using one trigger function and one custom variable.</p>

    </div>
</section>


    </body>
</html>

